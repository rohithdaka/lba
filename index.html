<!doctype html>
<script src="http://cdn.jsdelivr.net/mithril/0.2.0/mithril.min.js"></script>
<script>
    var lba = {};
    // Content for the page header
    var siteHeader = function(){
        return [
            m("title","Link Budget Analysis"),
            m("meta",{name: "author", content: "Rohith Daka"}),
            m("meta",{name: "keywords", content: "Link Budget Analysis"}),
            m("meta",{name: "description", content: "An online tool to do link budget analysis"}),
            m("link",{rel: "stylesheet", href: "lba.css"})
        ];
    };
    // calculator view component 
    var powerConversionUnits = [
        {'func': 'setdBW','suffix':'dBW'},
        {'func': 'setdBm','suffix':'dBm'},
        {'func': 'setmW','suffix':'mW'},
        {'func': 'setW','suffix':'W'}
    ];
    var powerConversion = function(control){
        return m("table", [
            m("caption","Power Units Converter"),
            powerConversionUnits.map(function(unit,index){
                return m("tr",
                    m("td", [
                        m("input[type=number]", {
                            oninput: m.withAttr("value", control[unit.func]),
                            value: control[unit.suffix]
                        }),
                        unit.suffix
                    ])
                );
            })
        ]);
    };
    
    var distanceConversionUnits = [
        {'func': 'setMiles','suffix':'Miles'},
        {'func': 'setKM','suffix':'KM'},
        {'func': 'setAU','suffix':'AU'},
    ];
    
    var distanceConversion = function(control){
        return m("table", [
            m("caption","Distance Units Converter"),
            distanceConversionUnits.map(function(unit,index){
                return m("tr",
                    m("td", [
                        m("input[type=number]", {
                            oninput: m.withAttr("value", control[unit.func]),
                            value: control[unit.suffix]
                        }),
                        unit.suffix
                    ])
                );
            })
        ]);
    };
    
        
    // link view component
    var linkParameters = [
        {'text':'Transmit Power','variable':'Pt','suffix':'dBm','calcvalue':false,'func':'setPt','initialValue':'25'},
        {'text':'Transmit Feeder/Pointing Losses','variable':'Lt','suffix':'dB','calcvalue':false,'func':'setLt','initialValue':'1'},
        {'text':'Transmit Antenna Gain','variable':'Gt','suffix':'dB','calcvalue':false,'func':'setGt','initialValue':'10'},
        {'text':'EIRP','variable':'EIRP','suffix':'dBm','calcvalue':true,'func':'setEIRP','initialValue':''},
        {'text':'Frequency','variable':'f','suffix':'MHz','calcvalue':false,'func':'setf','initialValue':'2400'},
        {'text':'Distance','variable':'D','suffix':'km','calcvalue':false,'func':'setD','initialValue':'1'},
        {'text':'Path Loss','variable':'Lp','suffix':'dB','calcvalue':true,'func':'setLp','initialValue':''},
        {'text':'Atmospheric Attenuation','variable':'La','suffix':'dB','calcvalue':false,'func':'setLa','initialValue':'3'},
        {'text':'Receive Antenna Gain','variable':'Gr','suffix':'dB','calcvalue':false,'func':'setGr','initialValue':'15'},
        {'text':'Receive Feeder/Pointing Losses','variable':'Lr','suffix':'dB','calcvalue':false,'func':'setLr','initialValue':'2'},
        {'text':'Received Power','variable':'Pr','suffix':'dBm','calcvalue':true,'func':'setPr','initialValue':''},
        {'text':'Thermal Noise Temperature','variable':'Nt','suffix':'Kelvin','calcvalue':false,'func':'setNt','initialValue':'300'},
        {'text':'Bandwidth','variable':'BW','suffix':'KHz','calcvalue':false,'func':'setBW','initialValue':'200'},
        {'text':'Noise Figure','variable':'Nf','suffix':'dB','calcvalue':false,'func':'setNf','initialValue':'2.5'},
        {'text':'Total Noise Power','variable':'Np','suffix':'dBm','calcvalue':true,'func':'setNp','initialValue':''},
        {'text':'SNR','variable':'SNR','suffix':'dB','calcvalue':true,'func':'setSNR','initialValue':''},
        {'text':'Data Rate','variable':'R','suffix':'bps','calcvalue':false,'func':'setR','initialValue':'1000'},
        {'text':'Eb/No','variable':'EbNo','suffix':'dB','calcvalue':true,'func':'setEbNo','initialValue':''}
    ];
    var linkCalculation = function(control){
        return m("table", [
            m("caption","Link Analysis"),
            linkParameters.map(function(param,index){
                return m("tr",
                    m("td",param.text),
                    m("td", [
                        m("input[type=number]", {
                            oninput: m.withAttr("value", control[param.func]),
                            value: control[param.variable],
                            readOnly: param.calcvalue
                        }),
                        param.suffix
                    ])
                );
            })
        ]);
        
    };
    
    // view of the body 
    var siteBody = function(control) {
        return [
            m("h1","Link Budget Analysis"),
            m("section#powerConverter]",powerConversion(control)),
            m("section#distanceConverter]",distanceConversion(control)),
            m("section#link",linkCalculation(control))
        ];
    }
    // Entire controller 
    lba.controller = function() {
        var ctrl = this;
        // Controller for Power conversion calculator 
        ctrl.setdBm = function(dBm) {
            this.dBm = +dBm;
            this.mW = +(Math.pow(10,dBm/10));
            this.W = +(this.mW * Math.pow(10,-3));
            this.dBW = +(dBm - 30);
        }.bind(ctrl);
        ctrl.setmW = function(mW) {
            this.mW = +mW;
            this.dBm = +(10*Math.log(mW)/Math.log(10));
            this.W = +(mW * Math.pow(10,-3));
            this.dBW = +(this.dBm - 30);
        }.bind(ctrl);   
        ctrl.setW = function(W){
            this.mW = +(W*Math.pow(10,3)).toFixed(2);
            this.dBm = +(10*Math.log(this.mW)/Math.log(10));
            this.W = +W;
            this.dBW = +(this.dBm - 30);
        }.bind(ctrl); 
        ctrl.setdBW = function(dBW){
            this.dBW = +dBW;
            this.dBm = +dBW + 30;
            this.mW = +(Math.pow(10,this.dBm/10));
            this.W = +(this.mW*Math.pow(10,-3));
        }.bind(ctrl); 
        ctrl.setdBm(0);
        
        //Controller for distance conversion
        ctrl.setMiles = function(M) {
            this.Miles = +M;
            this.KM = +(M*1.60934);
            this.AU = +(this.KM / 149597871);
        }.bind(ctrl);
  
        ctrl.setKM = function(KM) {
            this.KM = +KM;
            this.Miles = +(KM/1.60934);
            this.AU = +(KM/ 149597871);
        }.bind(ctrl);
        
        ctrl.setAU = function(AU){
            this.AU = +AU;
            this.KM = +(AU * 149597871 );
            this.Miles = +(this.KM/1.60934);
        }.bind(ctrl);
        
        ctrl.setKM(10);
        
        //Controller for Link
        
        var K = 1.3806488e-23;
        //looping through all the parameters to set the inputs and calculate the outputs
        linkParameters.map(function(p,index){
            ctrl[p.func] = function(x){
                ctrl[p.variable] = +x;
                ctrl.EIRP = +(ctrl.Pt + ctrl.Gt - ctrl.Lt) ;
                ctrl.Lp = +(20*Math.log(ctrl.D) + 20*Math.log(ctrl.f * Math.pow(10,-3)))/Math.log(10) + 92.45;
                ctrl.Pr = +(ctrl.EIRP - ctrl.Lp - ctrl.La + ctrl.Gr -ctrl.Lr);
                ctrl.Np = +((10*Math.log(ctrl.Nt * ctrl.BW * 1000 * K))/Math.log(10) + 30 + ctrl.Gr + ctrl.Nf);
                ctrl.SNR = +(ctrl.Pr - ctrl.Np);
                ctrl.EbNo = +( ctrl.SNR - (10*Math.log(ctrl.R / (ctrl.BW * 1000) ) )/Math.log(10));    
            }.bind(ctrl);
            
            ctrl[p.func](p.initialValue);
        }); 
        
        
    };
    
    // View of the entire site
    lba.view = function(control) {
        return m("html", [
            m("head", siteHeader()),
            m("body", siteBody(control))
        ]);
    };

    // initialising the app
    m.mount(document, lba);
    
</script>