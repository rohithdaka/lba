<!doctype html>
<script src="http://cdn.jsdelivr.net/mithril/0.2.0/mithril.min.js"></script>
<script>
    var lba = {};
    // Content for the page header
    var siteHeader = function(){
        return [
            m("title","Link Budget Analysis"),
            m("meta",{name: "author", content: "Rohith Daka"}),
            m("meta",{name: "keywords", content: "Channel Coding"}),
            m("link",{rel: "stylesheet", href: "lba.css"})
        ];
    };
    // calculator view component 
    var powerConversionUnits = [
        {'func': 'setdBW','suffix':'dBW'},
        {'func': 'setdBm','suffix':'dBm'},
        {'func': 'setmW','suffix':'mW'},
        {'func': 'setW','suffix':'W'}
    ];
    var powerConversion = function(power){
        return m("table", [
            m("caption","Power Units Convertor"),
            powerConversionUnits.map(function(unit,index){
                return m("tr",
                    m("td", [
                        m("input[type=number]", {
                            oninput: m.withAttr("value", power[unit.func]),
                            value: power[unit.suffix]
                        }),
                        unit.suffix
                    ])
                );
            })
        ]);
    };
    
    // link view component
    var linkParameters = [
        {'text':'Transmit Power','variable':'Pt','suffix':'dBm','calcvalue':false,'func':'setPt','initialValue':'25'},
        {'text':'Transmit Feeder/Pointing Losses','variable':'Lt','suffix':'dB','calcvalue':false,'func':'setLt','initialValue':'1'},
        {'text':'Transmit Antenna Gain','variable':'Gt','suffix':'dB','calcvalue':false,'func':'setGt','initialValue':'10'},
        {'text':'EIRP','variable':'EIRP','suffix':'dBm','calcvalue':true,'func':'setEIRP','initialValue':''},
        {'text':'Frequency','variable':'f','suffix':'MHz','calcvalue':false,'func':'setf','initialValue':'2400'},
        {'text':'Distance','variable':'D','suffix':'km','calcvalue':false,'func':'setD','initialValue':'1'},
        {'text':'Path Loss','variable':'Lp','suffix':'dB','calcvalue':true,'func':'setLp','initialValue':''},
        {'text':'Atmospheric Attenuation','variable':'La','suffix':'dB','calcvalue':false,'func':'setLa','initialValue':'3'},
        {'text':'Receive Antenna Gain','variable':'Gr','suffix':'dB','calcvalue':false,'func':'setGr','initialValue':'15'},
        {'text':'Receive Feeder/Pointing Losses','variable':'Lr','suffix':'dB','calcvalue':false,'func':'setLr','initialValue':'2'},
        {'text':'Received Power','variable':'Pr','suffix':'dBm','calcvalue':true,'func':'setPr','initialValue':''},
        {'text':'Thermal Noise Temperature','variable':'Nt','suffix':'Kelvin','calcvalue':false,'func':'setNt','initialValue':'300'},
        {'text':'Bandwidth','variable':'BW','suffix':'KHz','calcvalue':false,'func':'setBW','initialValue':'200'},
        {'text':'Noise Figure','variable':'Nf','suffix':'dB','calcvalue':false,'func':'setNf','initialValue':'2.5'},
        {'text':'Total Noise Power','variable':'Np','suffix':'dBm','calcvalue':true,'func':'setNp','initialValue':''},
        {'text':'SNR','variable':'SNR','suffix':'dB','calcvalue':true,'func':'setSNR','initialValue':''},
        {'text':'Data Rate','variable':'R','suffix':'bps','calcvalue':false,'func':'setR','initialValue':'1000'},
        {'text':'Eb/No','variable':'EbNo','suffix':'dB','calcvalue':true,'func':'setEbNo','initialValue':''}
    ];
    var linkCalculation = function(power){
        return m("table", [
            m("caption","Link Analysis"),
            linkParameters.map(function(param,index){
                return m("tr",
                    m("td",param.text),
                    m("td", [
                        m("input[type=number]", {
                            oninput: m.withAttr("value", power[param.func]),
                            value: power[param.variable],
                            readOnly: param.calcvalue
                        }),
                        param.suffix
                    ])
                );
            })
        ]);
        
    };
    
    // view of the body 
    var siteBody = function(power) {
        return [
            m("h1","Link Budget Analysis"),
            m("section#calculator]",powerConversion(power)),
            m("section#link",linkCalculation(power))
        ];
    }
    // Entire controller 
    lba.controller = function() {
        var ctrl = this;
        // Controller for Power conversion calculator 
        this.setdBm = function(dBm) {
            this.dBm = +dBm;
            this.mW = +(Math.pow(10,dBm/10));
            this.W = +(this.mW * Math.pow(10,-3));
            this.dBW = +(dBm - 30);
        }.bind(this);
  
        this.setmW = function(mW) {
            this.mW = +mW;
            this.dBm = +(10*Math.log(mW)/Math.log(10));
            this.W = +(mW * Math.pow(10,-3));
            this.dBW = +(this.dBm - 30);
        }.bind(this);
        
        this.setW = function(W){
            this.mW = +(W*Math.pow(10,3)).toFixed(2);
            this.dBm = +(10*Math.log(this.mW)/Math.log(10));
            this.W = +W;
            this.dBW = +(this.dBm - 30);
        }.bind(this);
        
        this.setdBW = function(dBW){
            this.dBW = +dBW;
            this.dBm = +dBW + 30;
            this.mW = +(Math.pow(10,this.dBm/10));
            this.W = +(this.mW*Math.pow(10,-3));
        }.bind(this);
    
        this.setdBm(0);
        
        //Controller for Link
        
        var K = 1.3806488e-23;
        //looping through all the parameters to set the inputs and calculate the outputs
        linkParameters.map(function(p,index){
            ctrl[p.func] = function(x){
                ctrl[p.variable] = +x;
                this.EIRP = +(this.Pt + this.Gt - this.Lt) ;
                this.Lp = +(20*Math.log(this.D) + 20*Math.log(this.f * Math.pow(10,-3)))/Math.log(10) + 92.45;
                this.Pr = +(this.EIRP - this.Lp - this.La + this.Gr -this.Lr);
                this.Np = +((10*Math.log(this.Nt * this.BW * 1000 * K))/Math.log(10) + 30 + this.Gr + this.Nf);
                this.SNR = +(this.Pr - this.Np);
                this.EbNo = +( this.SNR - (10*Math.log(this.R / (this.BW * 1000) ) )/Math.log(10));    
            }.bind(ctrl);
            
            ctrl[p.func](p.initialValue);
        });               
    };
    
    // View of the entire site
    lba.view = function(power) {
        return m("html", [
            m("head", siteHeader()),
            m("body", siteBody(power))
        ]);
    };

    // initialising the app
    m.mount(document, lba);
    
</script>